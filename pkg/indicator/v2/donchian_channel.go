package indicatorv2

import (
	"github.com/c9s/bbgo/pkg/types"
)

type DonchianChannelStream struct {
	UpBand, DownBand, MiddleBand *types.Float64Series
}

// The Donchian Channel (DC) calculates three lines generated by moving average
// calculations that comprise an indicator formed by upper and lower bands
// around a midrange or median band. The upper band marks the highest
// price of an asset while the lower band marks the lowest price of
// an asset, and the area between the upper and lower bands
// represents the Donchian Channel.
//
// Upper Channel = Mmax(period, closings)
// Lower Channel = Mmin(period, closings)
// Middle Channel = (Upper Channel + Lower Channel) / 2
func DonchianChannel(source KLineSubscription, window int) *DonchianChannelStream {
	var (
		closing = ClosePrices(source)
		s       = &DonchianChannelStream{
			UpBand:     types.NewFloat64Series(),
			DownBand:   types.NewFloat64Series(),
			MiddleBand: types.NewFloat64Series(),
		}
	)

	source.AddSubscriber(func(v types.KLine) {
		var (
			sample       = closing.Slice.Tail(window)
			upperChannel = sample.Max()
			lowerChannel = sample.Min()
		)
		s.UpBand.Push(upperChannel)
		s.DownBand.Push(lowerChannel)
		s.MiddleBand.Push((upperChannel + lowerChannel) / 2)
	})
	return s
}

func (s *DonchianChannelStream) Truncate() {
	s.UpBand.Slice = s.UpBand.Slice.Truncate(MaxNumOfMA)
	s.DownBand.Slice = s.DownBand.Slice.Truncate(MaxNumOfMA)
	s.MiddleBand.Slice = s.MiddleBand.Slice.Truncate(MaxNumOfMA)
}
